# TDS Support Tool
## Overview
`TDS_SupportTool` provides a web interface for various support tools, with features such as assessment loading, test package validation,

The `TDS_SupportTool` consists of four modules:

* **client:** Contains the POJOs/classes needed for a consumer to interact with the Assessment Package Loader
* **service:** Contains the spring application code and the angular web application
* **external-apis** Contains the spring application code for the external endpoints
* **shared** Contains code shared by the web application and external endpoints 

## General Usage

### Test Package Loader
The test package loader is a tool intended to facilitate the loading of test packages into various external systems - including TDS (via the Assessment Service), ART, TIS, and THSS

There are three primary screens in the test package loader section of the Support Tool app. The "Test Package Jobs" page
Clicking on the "Upload Test Packages" button navigates to the upload screen, where one or more test packages can be uploaded
at a time (each as an individual "load" job). Options are also available to prevent the loading of test packages into ART or any
of the scoring systems. The third page, titled "Loaded Test Packages" contains the current known state of test packages in
each subsystem - indicating whether or not a test package is currently successfully loaded into a system.

Please refer to the Support Tool User Guide for more detailed instructions on using the Test Package Loader

### Scoring Validator
The Scoring Validator's purpose is to validate previously scored TRT files by re-scoring each item within a
TRT using the scoring logic built into the open source TDS application, as well as the exam-level scores generated by TIS.

At a high level, the application:

- Parses the incoming TRT file(s)
- Re-scores each item within the file
- Creates a new TRT using the newly scored values
- Sends the new TRT to TIS for test/exam-level scoring
- Creates a scoring validation status report
- Contains a APIs for submitting TRTs for rescoring, obtaining the original and re-scored TRT, and for fetching the
scoring validation report

To create a scoring validation report:

1. Click on the "Scoring Validator" link in the top navigation bar.
2. Click the "Upload Test Results" button
3. Upload one or more TRT files by drag-and-dropping or by using a file upload window
4. Click "Create Scoring Jobs". You will then be redirected to the :Scoring Validation Jobs" screen
5. A job will be created for each uploaded TRT file. If the scoring validation job is successful (once it is processed by TIS),
a "Scoring Validation Report" button will become enabled. The report will contain general information about the TRT, as well as
any scoring data that may have changed between the original and re-scored TRTs. Additionally, the original and re-scored TRTs will
be made available for download.

A few additional things to note:

- Scoring job progress can be kept track of by selecting a scoring job from the "Scoring Validation Jobs" page. Additional job details
will be made available in the details pane below the jobs data grid.
- If a scoring validation job is unsuccessful for any reason, the scoring validation report will not be available and the job status will
read "FAIL".
- If a scoring validation job is successful (meaning it was successfully processed by TDS and TIS scoring engines and sent back to the Support Tool),
the job status will read "SUCCESS"

## External APIs
Several endpoints are enabled for external REST clients. These are authenticated via OAuth2 tokens obtained from Smarter Balanced
at https://sso-deployment.sbtds.org/auth/oauth2/access_token?realm=/sbac, as opposed to the web application, which
is authenticated via Single Sign-on (SSO) tokens managed in the user's browser. The endpoints are:

-- Post a TRT to rescore: causes a new job to be created, just as if the TRT was uploaded through the web app
-- Get all jobs for user: returns a list of all jobs created by currently authenticated user. 
-- Get specific job by job ID: returns info for the requested job if it exists and was created by the current user
-- Get rescored TRT by job ID: returns the rescored TRT
-- Get validation report by job ID: returns the difference report between the original TRT and the rescored TRT
 
## Setup
The following tools will be needed to build the project:

1. Maven
2. Java 8

The following external dependencies are required to run the support tool:

1. A mongodb instance with a `support-tool` database and authorized user
    - The database is used primarily to manage and track the state of the test package loading process, as well as to persist the status of loaded test packages
2. A rabbitmq server used to manage job execution and communication
3. An S3 repository
    a. Item content metadata is fetched from this repository when loading into THSS. The rubric list is read from this file and posted to THSS for item scoring configuration
    b. Test packages that are uploaded to the support tool are persisted for archival purposes

## Build
To build all modules, use the "parent" `pom.xml` that is contained in the `TDS_SupportTool` directory:

* `mvn clean install -f /path/to/parent/pom.xml`

To build the **client**:

* `mvn clean install -f /path/to/client/pom.xml`

To build the **shared**:

* `mvn clean install -f /path/to/shared/pom.xml`

To build the **service**:

* `mvn clean install -f /path/to/service/pom.xml`

To build the **external-apis**:

* `mvn clean install -f /path/to/external-apis/pom.xml`

To build all modules and run the integration tests:
  
* `mvn clean install -Dintegration-tests.skip=false -f /path/to/parent/pom.xm`

To build a specific module (client, shared, service, or external-apis) and run its integration tests:
  
* `mvn clean install -Dintegration-tests.skip=false -f /path/to/module/pom.xml`

### Docker Support
The Support Tool provides one `Dockerfile` for building a Docker image for the web app and a second for the
external APIs app. 

For the following commands to work, the Docker Engine must be installed on the target build machine.  
Resources for downloading and installing the Docker Engine on various operating systems can be found 
[here](https://docs.docker.com/engine/installation/).  For details on what Docker is and how it works, refer to 
[this page](https://www.docker.com/what-docker).

To build the web app service and its associated Docker image:

* `mvn clean install docker:build -f /path/to/service/pom.xml`

To build the external api app and its associated Docker image:

* `mvn clean install docker:build -f /path/to/external-apis/pom.xml`

### Run web app .JAR
To run the compiled jar built by one of the build commands above, use the following:

```
java -Xms256m -Xmx512m \
    -jar /path/to/target/tds-support-tool-service-0.0.1-SNAPSHOT.jar \
    --server-port="8080"
```
(substitute the current build version for 0.0.1-SNAPSHOT)

### Run external APIs .JAR
```
java -Xms256m -Xmx512m \
    -jar /path/to/target/tds-support-tool-external-service-0.0.1-SNAPSHOT.jar \
    --server-port="8080"
```
(substitute the current build version for 0.0.1-SNAPSHOT)

#### Additional Details for Interacting With Docker
The `Dockerfile` included in this repository is intended for use with [Spotify's Docker Maven plugin](https://github.com/spotify/docker-maven-plugin).  As such, the `docker build` command will fail because it cannot find the compiled `.jar`.

The Docker container can be started via `docker-compose` or `docker run`:

* The command for starting the container via `docker-compose`:  `docker-compose up -d -f /path/to/docker-compose.yml`
  * **NOTE:** If `docker-compose` is run in the same directory where the `docker-compose.yml` file is located, `docker-compose up -d` is sufficient to start the container
* Alternately, `docker run` can be used to start up the container:  `docker run -d -p [open port on host]:8080 --env-file /path/to/apl.env fwsbac/tds-support-tool-service`
  * example:  `docker run -d -p 23572:8080 --env-file support-tool.env fwsbac/tds-support-tool-service`

To see the list of running Docker containers, use the following command:

* `docker ps -a`
* Output will appear as follows:
 
```
CONTAINER ID        IMAGE                                     COMMAND                CREATED             STATUS              PORTS                     NAMES
de37db84cb30        fwsbac/tds-support-tool-service           "/docker-startup.sh"   2 hours ago         Up 2 hours          0.0.0.0:23489->8080/tcp   docker_support-tool_1
3f139113485c        fwsbac/tds-support-tool--external service "/docker-startup.sh"   2 hours ago         Up 2 hours          0.0.0.0:23490->8080/tcp   docker_support-tool-external_1
```

To tail the log files for the process(es) running on the Docker container:

* `docker logs -f [container id]`
  * **NOTE:**  To view the logs without tailing them, omit the `-f` from the command above
* example:  `docker logs -f de37db84cb30`

## Spring Configuration
The following is a brief explanation of the Spring properties that are available for the support tool service.  For ease of maintenance, the same properties are used
for both the web api (service) and external APIs, even though several only apply to one or the other. You can edit and alter these with Spring cloud configuration 
and in the `application.yml` file within the main src for local development

```
management: # the health and other actuator endpoints will run on "8008" while the web app runs on `server.port
  port: 8008
  security:
    enabled: false
  health:
    redis:
      enabled: false
    rabbit:
      enabled: false

server:
  port: # the port to run tomcat on - default is 8080
  context-path: # (Optional) the path to run the support tool application on (usually "/supporttool")

internalClientPort: # port used for service-to-service conmmunication, not exposed to external addresses default is 8883

spring:
  mvc:
    throw-exception-if-no-handler-found: true
  resources:
    add-mappings: true
  cloud:
    bus:
      enabled: false
  http.multipart.max-file-size: 50MB

#Port defined in TDS_Build:docker-compose.yml
  rabbitmq:
    port: 32846

data:
  s3:
    accessKey: # An AWS access key for a user that has read access to s3
    secretKey: # The corresponding AWS Secret key for the user that has read access to S3
    bucket-name: # Name of the bucket where loaded test packages should be stored
    test-package-prefix: # Path prefix of where the test packages should be stored

# OAuth2  # configuration to enable OAuth2 security used by external APIS
security:
  oauth2:
    token-info-url: ${support-tool.token-info-url}

#SAML # configuration for SSO security used by web app
saml:
  key-store-file: # location of keystore file
  key-store-password: ${tds.java.keystore.password}
  private-key-entry-alias: ${tds.java.private.key.alias}
  private-key-entry-password: ${tds.java.private.key.password}
  idp-metadata-url: ${tds.idp.metadata.url}
  sp-entity-id: ${tds.sp.entityid}

# URLs for dependent services
support-tool:
  art-rest-url: # the ART rest endpoint root (e.g., `http://<ART HOSTNAME>/rest`)
  assessment-url: # the Assessment Service API root (e.g., `http://tds-assessment-service`)
  exam-url: http://localhost:8081
  content-url:  http://localhost:32848
  thss-api-url: # the Teeacher Handscoring System API root (e.g., `http://<THSS HOSTNAME>/api`)
  tis-api-url: # the Test Integration System API root (e.g., `http://<TIS HOSTNAME>/api`)
  permissions-url: # url to get retrieve permissions based on an auth token

  progman-tenant-level: # the progman tenant level - either `DISTRICT`, `STATE`, `INSTITUTION`, or `CLIENT`
  progman-tenant: # the progman tenant to load test packages into - refer to ART documentation for more information about tenancy
  progman-url: # the Program Management API root (e.g., `http://<PROGMAN HOST>/rest`)

  sso-client-id: # the SSO client id to use for authorized REST calls
  sso-client-secret: # the SSO client secret to use for authorized REST calls
  sso-password: # the password of the SSO/OAuth user
  sso-url: # the url for obtaining an SSO access token (e.g., `https://<SSO HOST>/auth/oauth2/access_token?realm=/sbac`)
  token-info-url: https://sso-deployment.sbtds.org:443/auth/oauth2/tokeninfo?access_token={access_token}
  sso-username: # the SSO username used to create authorized OAuth REST calls to external services
```
